{{define "content"}}
<h1 class="text-2xl font-bold mb-1">My Account</h1>
<p class="text-sm text-gray-600 mb-4">
  Hi, {{.Parent.Name}} <span class="font-mono">({{.Phone}})</span> —
  <a class="underline" href="/account/logout">not you? use a different number</a>
</p>

{{template "flash" .}}

<div class="grid md:grid-cols-2 gap-6 items-start">
  <!-- Parent form -->
  <form method="POST" action="/account/profile" class="bg-white border rounded-2xl p-6 grid gap-3">
    <input type="hidden" name="phone" value="{{.Phone}}">
    <div>
      <label class="block text-sm text-gray-600 mb-1">Phone</label>
      <input class="w-full rounded-xl border p-2 bg-gray-50" value="{{.Parent.Phone}}" disabled>
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">Parent Name</label>
      <input name="parent_name" class="w-full rounded-xl border p-2" value="{{.Parent.Name}}" required>
    </div>
    <div>
    <label class="block text-sm text-gray-700 mb-1">Email (optional)</label>
      <input name="email" type="email" autocomplete="email" value="{{if .Parent.Email}}{{.Parent.Email}}{{end}}"
       placeholder="name@example.com"
       class="border rounded-xl px-3 py-2 w-full mb-3"/>
    </div>

    <button class="px-4 py-2 rounded-xl bg-gray-900 text-white w-max">Save</button>
  </form>


  <!-- Children list -->
  <div class="bg-white border rounded-2xl p-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Children (please contact admin to remove a child)</h2>
      <a class="text-sm underline" href="/account/children/new?phone={{.Phone}}">Add child</a>
    </div>
    <div class="space-y-3">
      {{if .Kids}}
        {{range .Kids}}
          <div class="p-3 border rounded-xl">
            <form method="POST" action="/account/children/edit" class="grid md:grid-cols-3 gap-3">
              <input type="hidden" name="child_id" value="{{.ID}}">
              <input type="hidden" name="phone" value="{{$.Parent.Phone}}">
              <div>
                <label class="block text-xs text-gray-600 mb-1">Name</label>
                <input name="child_name" class="w-full rounded-xl border p-2" value="{{.Name}}" required>
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">DOB</label>
                <input type="date" name="child_dob" class="w-full rounded-xl border p-2" value="{{.BirthDate.Format `2006-01-02`}}" required>
              </div>
              <div>
                <label class="block text-xs mb-1">Gender</label>
                <select name="child_gender" class="w-full rounded-xl border p-2">
                  <option value="" {{if eq .Gender ""}}selected{{end}}>—</option>
                  <option value="male" {{if eq .Gender "male"}}selected{{end}}>Male</option>
                  <option value="female" {{if eq .Gender "female"}}selected{{end}}>Female</option>
                </select>
              </div>

              <div class="flex items-end gap-2">
                <button class="px-3 py-2 rounded-xl bg-gray-900 text-white">Save</button>
              </div>
            </form>
          </div>
        {{end}}
      {{else}}
        <div class="text-gray-600">No children yet.</div>
      {{end}}
    </div>
  </div>
</div>

<!-- Link Telegram -->
<div class="mt-6 p-4 rounded-2xl border bg-white">
  <h2 class="text-lg font-semibold mb-2">Telegram</h2>

  {{if eq .Success "unlinked"}}
    <div class="mb-3 p-2 rounded bg-green-50 text-green-800 text-sm">Telegram has been unlinked.</div>
  {{end}}

  {{if .TGLinked}}
    <p class="text-sm text-gray-700 mb-2">
      Linked to
      {{if .TG.Username}}<span class="font-mono">@{{.TG.Username}}</span>{{else}}<strong>{{.TG.FirstName}}</strong>{{end}}
      {{if .TG.LinkedAt}} since {{fmtDateTime .TG.LinkedAt}}{{end}}
    </p>
    <form method="POST" action="/account/unlink_telegram" onsubmit="return confirm('Unlink Telegram from this account?')">
      <button class="px-3 py-2 rounded-xl border underline text-red-700">Unlink Telegram</button>
    </form>
  {{else}}
    {{if .LinkCode}}
      <p class="text-sm text-gray-700 mb-2">Your link code (valid ~10 minutes):</p>
      <div class="flex items-center gap-2 mb-3">
        <code id="tg-code" class="px-2 py-1 rounded bg-gray-100">{{.LinkCode}}</code>
        <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('tg-code').textContent)" class="text-sm underline">Copy</button>
      </div>
      <p class="text-sm text-gray-700">
        In Telegram, open the church bot and send: <code>/link {{.LinkCode}}</code>
      </p>
      <p class="text-xs text-gray-500 mt-2">Tip: or tap “Share my phone” in the bot to link instantly.</p>
    {{else}}
      <p class="text-sm text-gray-700 mb-3">
        Link your Telegram to receive reminders and QR codes directly in chat.
      </p>
      <div class="flex flex-col sm:flex-row gap-2">
        <form method="POST" action="/account/linkcode">
          <button class="px-3 py-2 rounded-xl border underline">Generate link code</button>
        </form>
        <a class="px-3 py-2 rounded-xl border underline" href="https://t.me/LOJF_NextGen_Bot" target="_blank">Open Telegram bot</a>
      </div>
    {{end}}
  {{end}}
</div>

{{end}}
{{define "parents/account_profile.tmpl"}}{{template "base" .}}{{end}}
