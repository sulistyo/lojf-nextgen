{{define "content"}}
<h1 class="text-2xl font-bold mb-4">Admin â€¢ Roster</h1>
{{$root := .}}
{{template "admin_nav" .}}

<form method="GET" class="bg-white p-4 border rounded-2xl grid md:grid-cols-5 gap-3 mb-4">
  <div>
    <label class="block text-xs text-gray-600 mb-1">From</label>
    <input type="date" name="from" value="{{.Filters.From}}" class="w-full rounded-xl border p-2">
  </div>
  <div>
    <label class="block text-xs text-gray-600 mb-1">To</label>
    <input type="date" name="to" value="{{.Filters.To}}" class="w-full rounded-xl border p-2">
  </div>
  <div>
    <label class="block text-xs text-gray-600 mb-1">Class</label>
    <select name="class_id" class="w-full rounded-xl border p-2">
      <option value="">All</option>
      {{range .Classes}}
        <option value="{{.ID}}" {{if eq (printf "%d" .ID) $.Filters.ClassID}}selected{{end}}>{{fmtDate .Date}} :: {{nl2br .Name}}</option>
      {{end}}
    </select>
  </div>
  <div>
    <label class="block text-xs text-gray-600 mb-1">Status</label>
    <select name="status" class="w-full rounded-xl border p-2">
      <option value="" {{if eq .Filters.Status ""}}selected{{end}}>All</option>
      <option value="confirmed" {{if eq .Filters.Status "confirmed"}}selected{{end}}>Confirmed</option>
      <option value="waitlisted" {{if eq .Filters.Status "waitlisted"}}selected{{end}}>Waitlisted</option>
      <option value="checked-in" {{if eq .Filters.Status "checked-in"}}selected{{end}}>Checked-in</option>
      <option value="canceled" {{if eq .Filters.Status "canceled"}}selected{{end}}>Canceled</option>
    </select>
  </div>
  <div class="flex gap-2 items-end">
    <button class="px-3 py-2 rounded-xl bg-gray-900 text-white">Filter</button>
    <a class="px-3 py-2 rounded-xl border"
       href="/admin/roster.csv?from={{.Filters.From}}&to={{.Filters.To}}&class_id={{.Filters.ClassID}}&status={{.Filters.Status}}&q={{.Filters.Q}}">Export CSV</a>
  </div>
</form>

<form class="mb-4 flex flex-wrap gap-2 items-end" method="GET" action="/admin/roster">
  <input type="hidden" name="from" value="{{.Filters.From}}">
  <input type="hidden" name="to" value="{{.Filters.To}}">
  <input type="hidden" name="class_id" value="{{.Filters.ClassID}}">
  <input type="hidden" name="status" value="{{.Filters.Status}}">

  <label class="text-sm">
    <span class="block mb-1">Search</span>
    <input name="q" value="{{.Filters.Q}}" placeholder="Child / Parent / Phone / Class / Code / Answers"
           class="border rounded-xl px-3 py-2 w-80">
  </label>

  <button class="px-4 py-2 rounded-xl bg-gray-900 text-white">Apply</button>
  <a class="px-3 py-2 rounded-xl border" href="/admin/roster">Clear</a>
</form>

<div class="mb2 text-sm text-gray-600">
  Showing {{len .Rows}} result(s)
</div>

<div class="mb-3 flex flex-wrap items-center gap-3">
  <label class="text-sm">
    <input id="rosterQuickFilter" placeholder="Type to filter rows..." class="border rounded-xl px-3 py-2 w-80">
  </label>
  <div class="text-sm text-gray-600">
    Showing <span id="rosterShownCount">0</span> / <span id="rosterTotalCount">0</span>
  </div>
</div>

<div class="bg-white border rounded-2xl overflow-x-auto">
  {{if .HasResult}}
  <table id="rosterTable" class="w-full text-sm">
    <thead>
      <tr class="text-left text-sm text-gray-600">
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="0">Reg Date</th>
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="1">Class</th>
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="2">Child</th>
        <th class="text-left px-3 py-2">Answers</th>
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="4">Parent</th>
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="5">Code</th>
        <th class="py-2 px-3 cursor-pointer select-none" data-sort="6">Status</th>
        <th class="py-2 px-3">Actions</th>
      </tr>
    </thead>

    <tbody id="rosterTbody">
      {{range .Rows}}
      <tr class="border-t">
        {{/* IMPORTANT: data-ts used for correct date sorting */}}
        <td class="py-2 px-3 whitespace-nowrap" data-ts="{{.CreatedAt.Unix}}">
          {{fmtDateTime .CreatedAt}}
        </td>

        <td class="py-2 px-3" data-ts="{{.ClassDate.Unix}}">
          {{.DateStr}} - {{nl2br .ClassName}}
        </td>

        <td class="align-top py-2">
          <div class="font-medium">{{.ChildName}}</div>
          <div class="text-xs text-gray-600">
            {{if .Gender}}<span class="inline-block px-2 py-0.5 rounded bg-gray-100">{{.Gender}}</span>{{end}}
            {{if .BirthDate}}<span class="inline-block px-2 py-0.5 rounded bg-gray-100">{{fmtDate .BirthDate}}</span>{{end}}
          </div>
        </td>

        <td class="align-top px-3 py-2 text-sm">
          {{with index $root.Answers .ID}}
            {{range $i, $s := .}}{{if $i}}, {{end}}{{ $s }}{{end}}
          {{end}}
        </td>

        <td class="py-2 px-3">
          <a class="underline" href="/admin/parents/{{.ParentID}}">{{.ParentName}}</a>
          <div class="text-xs text-gray-600">{{.ParentPhone}}</div>
        </td>

        <td class="py-2 px-3 whitespace-nowrap">
          <span class="font-mono">{{.Code}}</span>
          <a class="inline-block align-middle ml-2" href="/qr/{{.Code}}.png" target="_blank" title="Show QR">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="opacity:.85">
              <path d="M2 2h4v4H2V2zm1 1v2h2V3H3zM10 2h4v4h-4V2zm1 1v2h2V3h-2zM2 10h4v4H2v-4zm1 1v2h2v-2H3zM10 9h2v2h-2V9zm3 0h1v1h1v1h-2V9zm-3 3h1v1h-1v-1zm2 0h3v3h-3v-3z"/>
            </svg>
          </a>
        </td>

        <td class="py-2 px-3">
          {{if .CheckInStr}}
            checked-in at {{.CheckInStr}}
          {{else if eq .Status "waitlisted"}}
            Waitlist (#{{.WaitlistRank}})
          {{else}}
            {{.Status}}
          {{end}}
        </td>

        <td class="py-2 px-3 whitespace-nowrap space-x-2">
          {{if and (eq .Status "confirmed") (eq .CheckInStr "")}}
            <form method="POST" action="/admin/registrations/{{.ID}}/checkin" style="display:inline">
              <button class="text-xs underline">Check-in</button>
            </form>
          {{end}}

          <form method="POST" action="/admin/registrations/{{.ID}}/cancel" style="display:inline">
            <button class="text-xs underline">Cancel</button>
          </form>

          <form method="POST" action="/admin/registrations/{{.ID}}/delete" style="display:inline" onsubmit="return confirm('Delete this registration?')">
            <button class="text-xs underline">Delete</button>
          </form>
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{else}}
  <div class="p-6 text-gray-600">No registrations match your filters.</div>
  {{end}}
</div>
{{end}}

{{define "admin/roster.tmpl"}}{{template "base" .}}

<script>
(function () {
  const input = document.getElementById('rosterQuickFilter');
  const tbody = document.getElementById('rosterTbody');
  const shownEl = document.getElementById('rosterShownCount');
  const totalEl = document.getElementById('rosterTotalCount');

  if (!input || !tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr'));
  totalEl.textContent = rows.length;

  function updateCount() {
    const shown = rows.filter(r => r.style.display !== 'none').length;
    shownEl.textContent = shown;
  }

  function normalize(s){ return (s || '').toLowerCase().replace(/\s+/g,' ').trim(); }

  input.addEventListener('input', () => {
    const q = normalize(input.value);
    rows.forEach(tr => {
      const text = normalize(tr.innerText);
      tr.style.display = (!q || text.includes(q)) ? '' : 'none';
    });
    updateCount();
  });

  updateCount();
})();
</script>

<script>
(function () {
  const table = document.getElementById('rosterTable');
  const tbody = document.getElementById('rosterTbody');
  if (!table || !tbody) return;

  const state = { col: null, asc: true };

  function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function cmp(a, b) { return a < b ? -1 : a > b ? 1 : 0; }

  function getSortValue(tr, colIdx) {
    const td = tr.children[colIdx];
    if (!td) return { kind: 'text', v: '' };

    const ts = td.getAttribute('data-ts');
    if (ts !== null && ts !== '') {
      const n = Number(ts);
      if (Number.isFinite(n)) return { kind: 'num', v: n };
    }

    return { kind: 'text', v: normalize(td.innerText) };
  }

  function sortBy(colIdx) {
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.style.display !== 'none');
    const asc = (state.col === colIdx) ? !state.asc : true;
    state.col = colIdx;
    state.asc = asc;

    rows.sort((ra, rb) => {
      const a = getSortValue(ra, colIdx);
      const b = getSortValue(rb, colIdx);

      if (a.kind === 'num' && b.kind === 'num') {
        return asc ? (a.v - b.v) : (b.v - a.v);
      }

      const c = cmp(a.v, b.v);
      return asc ? c : -c;
    });

    rows.forEach(r => tbody.appendChild(r));
  }

  table.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const colIdx = parseInt(th.getAttribute('data-sort'), 10);
      if (!Number.isFinite(colIdx)) return;
      sortBy(colIdx);
    });
  });
})();
</script>

{{end}}
