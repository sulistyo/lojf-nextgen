{{define "content"}}
<h1 class="text-2xl font-bold mb-4">Admin • Edit Class</h1>
{{template "admin_nav" .}}

<form method="POST" action="/admin/classes/{{.Class.ID}}" class="grid gap-6 max-w-3xl bg-white p-6 rounded-2xl border">

  <!-- Core fields -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="md:col-span-2">
      <label class="block text-sm mb-1">Name</label>
      <input name="name" class="w-full rounded-xl border p-2" value="{{.Class.Name}}" required>
    </div>

    <div>
      <label class="block text-sm mb-1">Date</label>
      <input type="date" name="date" class="w-full rounded-xl border p-2" value="{{.DateVal}}" required>
    </div>

    <div>
      <label class="block text-sm mb-1">Time</label>
      <input type="time" name="time" class="w-full rounded-xl border p-2" value="{{.TimeVal}}">
    </div>

    <div>
      <label class="block text-sm mb-1">Capacity</label>
      <input type="number" min="0" name="capacity" class="w-full rounded-xl border p-2" value="{{.Class.Capacity}}" required>
    </div>
  </div>

  <div>
    <label class="block text-sm mb-1">Description</label>
    <textarea name="description" rows="4" class="w-full rounded-xl border p-2" placeholder="Describe this class (visible to parents)">{{.Class.Description}}</textarea>
  </div>

  <div class="grid grid-cols-2 gap-3">
  <div>
    <label class="block text-sm mb-1">Opens on (Jakarta)</label>
    <input type="date" name="open_date" class="w-full rounded-xl border p-2" value="{{.OpenDateVal}}">
  </div>
  <div>
    <label class="block text-sm mb-1">At (HH:MM)</label>
    <input type="time" name="open_time" class="w-full rounded-xl border p-2" value="{{.OpenTimeVal}}">
  </div>
</div>

  <hr class="my-2"/>

  <!-- Questions -->
  <h2 class="text-lg font-semibold">Custom Questions</h2>
  <p class="text-sm text-gray-600 -mt-1 mb-3">Add optional fields parents must answer for this class. “Radio” uses one option per line.</p>

  <div id="q-rows" class="space-y-4">
    {{range $i, $q := .Questions}}
    <div class="p-4 border rounded-xl">
      <input type="hidden" name="q_id[]" value="{{$q.ID}}">

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Label</label>
          <input name="q_label[]" value="{{$q.Label}}" class="w-full rounded-xl border p-2" placeholder="e.g. Allergy notes">
        </div>

        <div>
          <label class="block text-sm mb-1">Type</label>
          <select name="q_kind[]" class="w-full rounded-xl border p-2">
            <option value="text"  {{if eq $q.Kind "text"}}selected{{end}}>Text</option>
            <option value="radio" {{if eq $q.Kind "radio"}}selected{{end}}>Radio</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">Position</label>
          <input type="number" name="q_position[]" value="{{$q.Position}}" class="w-full rounded-xl border p-2">
        </div>
      </div>

      <div class="mt-3">
        <label class="inline-flex items-center space-x-2">
          <!-- IMPORTANT: index-specific name to match handler -->
          <input type="checkbox" name="q_required_{{$i}}" {{if $q.Required}}checked{{end}}>
          <span class="text-sm">Required</span>
        </label>
      </div>

      <div class="mt-3">
        <label class="block text-sm mb-1">Choices (for Radio; separate with comma for each option)</label>
        <textarea name="q_choices[]" rows="3" class="w-full rounded-xl border p-2">{{$q.Options}}</textarea>
      </div>

      <div class="mt-3">
        <label class="inline-flex items-center space-x-2 text-red-600">
          <input type="checkbox" name="q_delete[]" value="1">
          <span class="text-sm">Delete this question</span>
        </label>
      </div>
    </div>
    {{end}}
  </div>

  <!-- Add row -->
  <div>
    <button type="button" id="btn-add-q" class="px-3 py-2 rounded-xl bg-gray-100 border">+ Add Question</button>
  </div>

  <div>
    <button class="px-4 py-2 rounded-xl bg-gray-900 text-white">Save</button>
    <a class="ml-3 underline" href="/admin/classes">Cancel</a>
  </div>
</form>

<!-- Hidden template for new question rows -->
<template id="q-template">
  <div class="p-4 border rounded-xl">
    <input type="hidden" name="q_id[]" value="">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm mb-1">Label</label>
        <input name="q_label[]" class="w-full rounded-xl border p-2" placeholder="Question label">
      </div>

      <div>
        <label class="block text-sm mb-1">Type</label>
        <select name="q_kind[]" class="w-full rounded-xl border p-2">
          <option value="text">Text</option>
          <option value="radio">Radio</option>
        </select>
      </div>

      <div>
        <label class="block text-sm mb-1">Position</label>
        <input type="number" name="q_position[]" value="0" class="w-full rounded-xl border p-2">
      </div>
    </div>

    <div class="mt-3">
      <!-- For new rows we can’t know the numeric index ahead of time; handler treats missing as unchecked -->
      <label class="inline-flex items-center space-x-2">
        <input type="checkbox" name="q_required_new">
        <span class="text-sm">Required</span>
      </label>
    </div>

    <div class="mt-3">
      <label class="block text-sm mb-1">Choices (for Radio; one per line)</label>
      <textarea name="q_choices[]" rows="3" class="w-full rounded-xl border p-2" placeholder="Option A&#10;Option B"></textarea>
    </div>

    <div class="mt-3">
      <label class="inline-flex items-center space-x-2 text-red-600">
        <input type="checkbox" name="q_delete[]" value="1">
        <span class="text-sm">Delete this question</span>
      </label>
    </div>
  </div>
</template>

<script>
(function(){
  const addBtn = document.getElementById('btn-add-q');
  const rows   = document.getElementById('q-rows');
  const tpl    = document.getElementById('q-template');
  if (!addBtn || !rows || !tpl) return;

  addBtn.addEventListener('click', function(){
    const node = document.importNode(tpl.content, true);
    rows.appendChild(node);
    // Note: new rows’ "required" checkbox uses name="q_required_new".
    // The server treats it as unchecked unless you enhance JS to reindex names before submit.
  });
})();
</script>
{{end}}

{{define "admin/classes_edit.tmpl"}}{{template "base" .}}{{end}}
